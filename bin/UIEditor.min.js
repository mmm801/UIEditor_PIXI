function Director(){var a={};this.addObserver=function(b,c,d){var e={};e.target=b,e.func=d;var f=[];a.hasOwnProperty(c)?f=a[c]:a[c]=f;for(var g in f)if(f[g].target==b&&f[g].func==d)return;f.push(e)},this.postMsg=function(b){if(a.hasOwnProperty(b)){var c,d=a[b],e=d.length,f=null,g=arguments.length,h=[];for(c=1;g>c;c++)h.push(arguments[c]);for(c=e-1;c>=0;c--){f=d[c];var i=f.func;h.length>0?i.apply(f.target,h):i.apply(f.target)}}},this.removeObserver=function(b){if(a.hasOwnProperty(b))for(var c=a[b],d=c.length,e=null,f=d-1;f>=0;f--)e=c[f],e.target==target&&(c.splice(f,1),e.taret=null,e.fun=null,e=null)},this.changeScene=function(a,b){function c(){20!=d&&(20>d&&(d++,10==d&&(a.stage.alpha=1,a.stage=f.content,e=!0),requestAnimationFrame(c)),e===!1?a.stage.alpha-=.1:(f.content.alpha+=.1,20==d&&(f.content.alpha=1,f.onEnter())))}var d=0,e=!1,f=UIManager.getInstance().uiPool[b];f.content.alpha=0,UIManager.getInstance().currentFile=UIManager.getInstance().filePool[b],c()}}function DragManager(){this.maxID=1,this.dragPool=[],this.enabled=!0,this.addDragObj=function(a,b,c,d){var e=new DragObject;return e.id=this.maxID,e.target=a,e.callBack=b,void 0!=c&&(e.dragWidth=c),void 0!=d&&(e.dragHeight=d),this.maxID++,this.dragPool.push(e),this.packageEvent(e),e},this.removeDrag=function(a){var b=null;for(var c in this.dragPool)if(this.dragPool[c].target==a){b=this.dragPool[c],this.dragPool.splice(c,1),this.removeEvent(b);break}},this.removeEvent=function(a){a.target.interactive=!1,a.target.buttonMode=!1,a.target.removeListener("mousedown")},this.packageEvent=function(a){function b(f){f.stopPropagation(),a.target.alpha=1,a.eventData=null,a.target.removeListener("mousemove",c),a.target.removeListener("mouseup",b),document.body.removeEventListener("mouseup",b),a.target.parent.addChildAt(d.target,e),a.dragComplete()}function c(a){a.stopPropagation();var b=a.data.getLocalPosition(this.parent);if(d.eventData)if(-1==d.dragWidth||-1==d.dragHeight)d.target.x=d.posX+b.x-d.mouseX,d.target.y=d.posY+b.y-d.mouseY;else{var c=b.x-d.mouseX,e=b.y-d.mouseY;d.target.x=d.posX+c,d.target.y=d.posY+e,d.target.x>d.dragWidth?d.target.x=d.dragWidth:d.target.x<0&&(d.target.x=0),d.target.y>d.dragHeight?d.target.y=d.dragHeight:d.target.y<0&&(d.target.y=0)}null!=d.moveCallBack&&d.moveCallBack(d.target)}var d=a;a.target.interactive=!0,a.target.buttonMode=!0;var e=-1;a.target.on("mousedown",function(a){if(a.stopPropagation(),0!=d.enabled){e=d.target.parent.getChildIndex(d.target),d.target.parent.addChild(d.target);var f=a.data.getLocalPosition(d.target.parent);d.target.alpha=.5,d.posX=d.target.x,d.posY=d.target.y,d.eventData=a.data,d.mouseX=f.x,d.mouseY=f.y,d.target.on("mousemove",c),d.target.on("mouseup",b),document.body.addEventListener("mouseup",b)}})}}function DragObject(){this.target=null,this.callBack=null,this.moveCallBack=null,this.posX=-1,this.posY=-1,this.eventData=null,this.mouseX=-1,this.mouseY=-1,this.dragWidth=-1,this.dragHeight=-1,this.maxWidth=-1,this.maxHeight=-1,this.downTime=0,this.sourceX=-1,this.sourceY=-1,this.scrollSpdx=0,this.scrollSpdy=0,this.dragMask=null,this.dragComplete=function(){this.callBack&&this.callBack(this.target)}}function EditController(){function a(a){var d=a.keyCode;return(a.ctrlKey||a.metaKey)&&83==d?(Director.getInstance().postMsg("fileSave"),a.preventDefault(),!1):(a.ctrlKey||a.metaKey)&&0==a.shiftKey&&90==d?(c>0&&(c--,Director.getInstance().postMsg("fileUndo",b[c])),a.preventDefault(),!1):(a.ctrlKey||a.metaKey)&&a.shiftKey&&90==d?(c<b.length&&(Director.getInstance().postMsg("fileRedo",b[c]),c++),a.preventDefault(),!1):void 0}var b=[],c=0;this.rollBack=function(){c--},this.rollNext=function(){c++},this.addAction=function(a){b.length!=c&&b.splice(c,b.length-c),b.push(a),c++},document.onkeydown=a,window.onload=function(){document.body.addEventListener("paste",function(a){var a=a||window.event;return Director.getInstance().postMsg("filePaste",a),a.preventDefault(),!1}),document.body.addEventListener("cut",function(a){var a=a||window.event;return Director.getInstance().postMsg("fileCut",a),a.preventDefault(),!1}),document.body.addEventListener("copy",function(a){var a=a||window.event;return Director.getInstance().postMsg("fileCopy",a),a.preventDefault(),!1})}}function Editor(){this.arr=[],this.elmJsonMap=null,this.rootId=0,this.waitPool={},this.pixiApp=null,this.pixiLayout=null,this.currentFrameNum=0,this.currentElm=null,this.stageContent=new PIXI.Graphics,this.stageMask=new PIXI.Graphics,this.setZoom=function(a){this.stageContent.scale=new PIXI.Point(a/100,a/100)},this.setMask=function(a){a?this.stageContent.mask=this.stageMask:this.stageContent.mask=null},this.updateSceneSize=function(){this.stageContent.clear(),this.stageContent.beginFill(parseInt("0x"+UIProject.getInstance().currentUI.backcolor),1),this.stageContent.drawRect(0,0,UIProject.getInstance().currentUI.width,UIProject.getInstance().currentUI.height),this.stageContent.endFill(),this.stageMask.width=UIProject.getInstance().currentUI.width,this.stageMask.height=UIProject.getInstance().currentUI.height;for(var a in this.arr)this.arr[a].updateView()},this.initStage=function(a,b,c){this.pixiApp=new PIXI.Application(b,c),document.getElementById(a).appendChild(this.pixiApp.view),this.pixiLayout=new Layout(b,c),this.stageContent.beginFill(16777215,1),this.stageContent.drawRect(0,0,600,400),this.stageContent.endFill(),this.stageContent.x=(b-600)/2,this.stageContent.y=50,DragManager.getInstance().addDragObj(this.stageContent),this.stageMask.beginFill(16711680,1),this.stageMask.drawRect(0,0,10,10),this.stageMask.endFill(),this.stageMask.width=this.stageContent.width,this.stageMask.height=this.stageContent.height,this.stageMask.visible=!1,this.pixiApp.stage.addChild(this.stageContent),this.stageContent.addChild(this.stageMask),this.pixiApp.stage.addChild(this.pixiLayout),this.pixiLayout.y=500,this.clear()},this.clear=function(){this.elmJsonMap=null},this.setJsonMap=function(a,b){if(this.rootId=0,this.clear(),this.elmJsonMap=a.elmJsonMap,this.removeAll(),this.updateSceneSize(),this.drawElm(!1),1==b)for(var c=this.arr.length,d=c-1;d>=0;d--)if(this.arr[d].rootId==this.rootId){this.elementUpdate(this.arr[d]);break}},this.removeAll=function(){for(;this.arr.length>0;){var a=this.arr.pop();a.removeFromParent()}},this.addChild=function(a,b){if(0==a.errorNo){var c=this.stageContent,d=null;if(0!=a.rootId){if(d=this.getElmById(a.rootId),null==d)return null==this.waitPool[a.rootId]&&(this.waitPool[a.rootId]=[]),this.waitPool[a.rootId].push(a),void this.arr.push(a);d.childrenNum++,c=d.content}if(null!=this.waitPool[a.id]){var e=this.waitPool[a.id].length,f=null;a.childrenNum+=e;for(var g=0;e>g;g++)f=this.waitPool[a.id][g],a.content.addChild(f.view),f.order=a.content.getChildIndex(f.view)}c.addChild(a.view),a.order=c.getChildIndex(a.view),this.arr.push(a),a.rootId==this.rootId&&this.pixiLayout.content.addChild(a.layer),b&&Director.getInstance().postMsg("elementUpdate",a)}},this.loadSceneOver=function(a){null==a?(this.elmJsonMap={},this.initStage(this.screenType)):(this.elmJsonMap=a,this.initStage(this.screenType))},this.loadElmData=function(a){null==a?Director.getInstance().postMsg("loadSceneOver",null):$.get("/H5/"+a+"?"+Math.random(),function(a){var b=JSON.parse(a);Director.getInstance().postMsg("loadSceneOver",b)}).error(function(a,b,c){Director.getInstance().postMsg("loadSceneOver",null)})},this.drawElm=function(a){var b=[];for(var c in this.elmJsonMap)b.push(JSON.parse(this.elmJsonMap[c]));b.sort(function(a,b){return a.order-b.order});for(var d=b.length,e=null,f=0;d>f;f++)e=elmFactory(b[f]),a&&f==d-1?this.addChild(e,!1):this.addChild(e,!1);this.checkRootLevel()},this.changeElm=function(a,b){this.updateChild(a,b)},this.elementUpdate=function(a){null!=this.elmJsonMap&&(this.doChange(a),this.doElementUpdate(a))},this.doElementUpdate=function(a){a.getPropertiesHtml(),this.updateFrameSetProperty(a),null!==this.currentElm&&this.currentElm.layer.setSelect(!1),this.currentElm=a,this.currentElm.layer.setSelect(!0),this.currentElm.checkFrame(UIProject.getInstance().currentEditor.currentFrameNum,UIProject.getInstance().currentUI.actionIndex),this.updateLayout()},this.addPaste=function(a){if(null!=this.elmJsonMap){var b=JSON.parse(a),c=elmCreate(b);c.rootId=this.rootId,this.addChild(c,!0)}},this.addUI=function(){if(null!=this.elmJsonMap){var a=new UIElement;a.rootId=this.rootId,this.addChild(a,!0)}},this.addPic=function(){if(null!=this.elmJsonMap){var a=new PicElement;a.rootId=this.rootId,this.addChild(a,!0)}},this.addText=function(){if(null!=this.elmJsonMap){var a=new TextElement;a.rootId=this.rootId,this.addChild(a,!0)}},this.doChange=function(a){var b=UIProject.getInstance().currentUI,c=JSON.stringify(b);this.elmJsonMap[a.id]=a.getJson();var d=JSON.stringify(b);EditController.getInstance().addAction({action:"changeFile",oldData:c,newData:d,elmId:a.id})},this.addSlice9=function(){if(null!=this.elmJsonMap){var a=new Slice9Element;a.rootId=this.rootId,this.addChild(a,!0)}},this.addShape=function(){if(null!=this.elmJsonMap){var a=new ShapeElement;a.rootId=this.rootId,this.addChild(a,!0)}},this.delElm=function(a){this.removeChildById(a),delete this.elmJsonMap[a]},this.layerClick=function(a,b){switch(b){case 1:UIProject.getInstance().currentEditor.selectElm(a.id);break;case 2:UIProject.getInstance().currentEditor.hiddenElm(a.id);break;case 3:UIProject.getInstance().currentEditor.lockElm(a.id);break;case 4:UIProject.getInstance().currentEditor.moveElm(a.id);break;case 5:UIProject.getInstance().currentEditor.enterElm(a.id)}},this.moveComplete=function(a){a.updateMove(this.currentFrameNum)},Director.getInstance().addObserver(this,"elementUpdate",this.elementUpdate),Director.getInstance().addObserver(this,"loadSceneOver",this.loadSceneOver),Director.getInstance().addObserver(this,"moveComplete",this.moveComplete),Director.getInstance().addObserver(this,"layerClick",this.layerClick),this.getJson=function(){return JSON.stringify(this.elmJsonMap)},this.updateLayout=function(){this.arr.sort(function(a,b){return a.order>b.order?-1:1});var a="<table>";a+="<tr  class='cell'><td><a href='javascript:UIProject.getInstance().currentEditor.enterElm(0);'>root</a></td>";for(var b=this.rootId,c=0,d=null;b>0;)c++,d=this.getElmById(b),b=d.rootId,a+="<td><a href ='javascript:UIProject.getInstance().currentEditor.enterElm("+d.id+");'>"+d.instName+"</a></td>";4>c&&(a+="<td colspan='"+(4-c)+"'></td>"),a+="</tr>",a+="</table>",document.getElementById("navigate").innerHTML=a;var e=[];for(var f in this.arr)this.arr[f].layer.parent&&this.arr[f].layer.parent.removeChild(this.arr[f].layer),this.arr[f].rootId==this.rootId&&(e.push(this.arr[f]),this.pixiLayout.content.addChild(this.arr[f].layer));this.pixiLayout.updateView(e)},this.updateChild=function(a,b){for(var c=this.arr.length,d=0;c>d;d++)if(this.arr[d].id==b){this.arr[d].changeElm(a);break}},this.selectElm=function(a){for(var b=this.arr.length,c=0;b>c;c++)if(this.arr[c].id==a){Director.getInstance().postMsg("elementUpdate",this.arr[c]);break}},this.hiddenElm=function(a){var b=this.getElmById(a);b.view.visible=!b.view.visible,b.updateLayer()},this.lockElm=function(a){var b=this.getElmById(a);b.view.interactive=!b.view.interactive,b.updateLayer()},this.enterElm=function(a){this.rootId=a,this.checkRootLevel();for(var b=this.arr.length,c=0;b>c;c++)if(this.arr[c].rootId==this.rootId){Director.getInstance().postMsg("elementUpdate",this.arr[c]);break}this.updateLayout()},this.checkRootLevel=function(){for(var a=this.arr.length,b=0;a>b;b++)this.arr[b].rootId==this.rootId?(this.arr[b].view.interactive=!0,this.arr[b].view.buttonMode=!0):(this.arr[b].view.interactive=!1,this.arr[b].view.buttonMode=!1)},this.getElmById=function(a){for(var b=this.arr.length,c=0;b>c;c++)if(this.arr[c].id==a)return this.arr[c];return null},this.moveElm=function(a){var b=this.arr.length,c=null;if(c=this.getElmById(a),null!=c){var d=this.stageContent.getChildIndex(c.view);if(0!=d){for(var e=d-1,f=null,g=0;b>g;g++){var h=this.stageContent.getChildIndex(this.arr[g].view);if(h==e){f=this.arr[g];break}}this.stageContent.swapChildren(f.view,c.view),f.order=d,c.order=d-1,this.elmJsonMap[f.id]=f.getJson(),this.elmJsonMap[c.id]=c.getJson(),this.updateLayout()}}},this.removeChildById=function(a){for(var b=this.arr.length,c=0;b>c;c++)if(this.arr[c].id==a){this.arr[c].childrenNum>0?alert("请先删除子元素"):(this.arr[c].destroy(),this.arr.splice(c,1));break}b=this.arr.length;for(var c=0;b>c;c++)this.arr[c].rootId==this.rootId&&(this.arr[c].order=this.arr[c].view.parent.getChildIndex(this.arr[c].view),Director.getInstance().postMsg("elementUpdate",this.arr[c]));this.updateLayout()},this.deleteFrameSet=function(a){this.currentElm.deleteFrameSet(a,UIProject.getInstance().currentUI.actionIndex),this.elmJsonMap[this.currentElm.id]=this.currentElm.getJson(),this.updateFrameSetProperty(this.currentElm),this.updateLayout();for(var b in this.arr)this.arr[b].checkFrame(a,UIProject.getInstance().currentUI.actionIndex)},this.addFrameSet=function(a){var b=new FrameSet;b.frame=a;var c=this.currentElm.getCheckFrameObj(a,UIProject.getInstance().currentUI.actionIndex);if(null!==c){b.width=c.width,b.height=c.height,b.scaleX=c.scaleX,b.scaleY=c.scaleY;var d=UIProject.getInstance().currentUI.getViewXValue(this.currentElm.posX,this.currentElm.PosTypeX),e=UIProject.getInstance().currentUI.getViewYValue(this.currentElm.posY,this.currentElm.PosTypeY);b.posX=c.posX-d,b.posY=c.posY-e,b.rotation=c.rotation,b.alpha=c.alpha,b.visible=c.visible,"pic"==this.currentElm.type&&(b.resName=c.resName)}else b.width=this.currentElm.width,b.height=this.currentElm.height,b.scaleX=this.currentElm.scaleX,b.scaleY=this.currentElm.scaleY,b.posX=0,b.posY=0,b.rotation=this.currentElm.rotation,"pic"==this.currentElm.type&&(b.resName=this.currentElm.resName);this.currentElm.addFrameSet(b,UIProject.getInstance().currentUI.actionIndex),this.doChange(this.currentElm),this.updateFrameSetProperty(this.currentElm),this.updateLayout()},this.changeFrame=function(a,b){var c=this.currentElm.getFrameSet(b,UIProject.getInstance().currentUI.actionIndex);c.changeFrame(a,this.currentElm),Director.getInstance().postMsg("elementUpdate",this.currentElm)},this.updateFrameSetProperty=function(a){var b="";if(0==this.currentFrameNum){for(var c in UIProject.getInstance().currentUI.actionList)b+="<div><input type='text' size = '10' id='action"+c+"' value='"+UIProject.getInstance().currentUI.actionList[c].actionName+"' onchange='UIProject.getInstance().changeAction("+c+")'/>",b+="<input type='text' size ='3' id='time"+c+"' value='"+UIProject.getInstance().currentUI.actionList[c].actionTime+"' onchange='UIProject.getInstance().changeAction("+c+")'/>",b+="<input type='text' size ='3' id='interval"+c+"' value='"+UIProject.getInstance().currentUI.actionList[c].interval+"' onchange='UIProject.getInstance().changeAction("+c+")'/>",c!=UIProject.getInstance().currentUI.actionIndex&&(b+="<button onclick='UIProject.getInstance().selectAction("+c+");'>选择</button>",b+="<button onclick='UIProject.getInstance().deleteAction("+c+");'>删除</button>",b+="</div>");return b+="<div><input type='text' id='newAction' value='action"+UIProject.getInstance().currentUI.actionList.length+"' size='10'/>",b+="<input type='text' id='newTime' value='30' size='3'/>",b+="<input type='text' id='newInterval' value='1' size='3'/>",b+="<button onclick='UIProject.getInstance().addNewAction();'>新增</button></div>",void(document.getElementById("frameProperty").innerHTML=b)}var d=a.getCheckFrameObj(this.currentFrameNum,UIProject.getInstance().currentUI.actionIndex);null==d?b+="<div>FrameSet:"+this.currentFrameNum+"<button onclick='UIProject.getInstance().currentEditor.addFrameSet("+this.currentFrameNum+")'>新建</button></div>":this.currentFrameNum==d.frame?(b+="<div>FrameSet:"+d.frame+"<button onclick='UIProject.getInstance().currentEditor.deleteFrameSet("+this.currentFrameNum+");'>删除</button></div>",b+=this.getPropertyContent(d,a,"")):(b+="<div>FrameSet:"+this.currentFrameNum+"<button onclick='UIProject.getInstance().currentEditor.addFrameSet("+this.currentFrameNum+")'>新建</button></div>",b+=this.getPropertyContent(d,a,"disabled")),document.getElementById("frameProperty").innerHTML=b},this.getPropertyContent=function(a,b,c){var d=UIProject.getInstance().currentUI.getViewXValue(b.posX,b.PosTypeX),e=UIProject.getInstance().currentUI.getViewYValue(b.posY,b.PosTypeY);a.posX-=d,a.posY-=e;var f="";if(f+="<table>",f+="<tr><td>宽:<input type='text' "+c+" id='f_width' value='"+a.width+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td>",f+="<td>高:<input type='text' "+c+" id='f_height' value='"+a.height+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+="<tr><td>X:<input type='text' "+c+" id='f_x' value='"+a.posX+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td>",f+="<td>Y:<input type='text' id='f_y' "+c+" value='"+a.posY+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+="<tr><td>scaleX:<input type='text' "+c+" id='f_scaleX' value='"+a.scaleX+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td>",f+="<td>scaleY:<input type='text' "+c+" id='f_scaleY' value='"+a.scaleY+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+="<tr><td colspan='2'>旋转:<input type='text' "+c+" id='f_rotation' value='"+a.rotation+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+="<tr><td colspan='2'>透明度:<input type='text' "+c+" id='f_alpha' value='"+a.alpha+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+=a.visible?"<tr><td colspan='2'>显示:<input type='checkbox' "+c+" id='f_visible' checked onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>":"<tr><td colspan='2'>显示:<input type='checkbox' "+c+" id='f_visible' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>","pic"==b.type){f+="<tr><td>图片:</td><td>",f+="<select id='f_resName' "+c+" onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'>";for(var g in UIProject.getInstance().resMap)f+=g==a.resName?"<option value='"+g+"' selected>"+g+"</option>":"<option value='"+g+"'>"+g+"</option>";f+="</select>"}return f+=a.b_continue?"<tr><td colspan='2'>补间:<input type='checkbox' "+c+" id='f_continue' checked onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>":"<tr><td colspan='2'>补间:<input type='checkbox' "+c+" id='f_continue' onchange='UIProject.getInstance().currentEditor.changeFrame(this,"+this.currentFrameNum+");'/></td></tr>",f+="</table>"},this.selectFrame=function(a){this.currentFrameNum=a;for(var b in this.arr)this.arr[b].rootId==this.rootId&&this.arr[b].checkFrame(a,UIProject.getInstance().currentUI.actionIndex);this.updateFrameSetProperty(this.currentElm)},this.removeAction=function(a){for(var b in this.arr)this.arr[b].rootId==this.rootId&&this.arr[b].removeAction(a)},this.keyPointDrag=function(a,b){var c=this.currentElm.getFrameSet(a,UIProject.getInstance().currentUI.actionIndex);null!=c&&(b=b>0?Math.floor((b-5)/10):Math.ceil((b-5)/10),c.frame=b,Director.getInstance().postMsg("elementUpdate",this.currentElm))},Director.getInstance().addObserver(this,"keyPointDrag",this.keyPointDrag),Director.getInstance().addObserver(this,"selectFrame",this.selectFrame),Director.getInstance().addObserver(this,"updateSceneSize",this.updateSceneSize)}function Slice9Element(a){BaseElement.call(this),this.type="slice9",this.instName=this.type,void 0==a?this.resName=UIProject.getInstance().defaultResKey:this.resName=a,this.leftWidth=10,this.topHeight=10,this.rightWidth=10,this.bottomHeight=10,this.percentWidth=0,this.percentHeight=0;var b=null;return null===this.resName?(alert("请先加载res资源"),void(this.errorNo=1)):(b=UIProject.getInstance().loaderRes?UIProject.getInstance().loaderRes[this.resName].texture:UIManager.getInstance().loaderRes[this.resName].texture,this.content=new PIXI.mesh.NineSlicePlane(b,this.leftWidth,this.topHeight,this.rightWidth,this.bottomHeight),this.width=this.content.width,this.height=this.content.height,this.view.addChild(this.content),this.getJson=function(){var a=this.getBaseJsonObj();return a.resName=this.resName,a.percentWidth=this.percentWidth,a.percentHeight=this.percentHeight,a.leftWidth=this.leftWidth,a.topHeight=this.topHeight,a.rightWidth=this.rightWidth,a.bottomHeight=this.bottomHeight,JSON.stringify(a)},this.setJson=function(a){this.setBaseJson(a);this.resName=a.resName,this.percentWidth=a.percentWidth,this.percentWidth=a.percentWidth,this.leftWidth=a.leftWidth,this.topHeight=a.topHeight,this.rightWidth=a.rightWidth,this.bottomHeight=a.bottomHeight,this.updateView(),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY)},this.getPropertiesHtml=function(){var a=this.getBasePropertiesDiv();a+="<table border='1'>",a+="<tr><td>图片:</td><td>",a+="<select id='resName' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'>";for(var b in UIProject.getInstance().resMap)a+=b==this.resName?"<option value='"+b+"' selected>"+b+"</option>":"<option value='"+b+"'>"+b+"</option>";a+="</select>",a+="</td></tr>",a+="<tr><td>左:<input type='text' id='leftWidth' value='"+this.leftWidth+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td><td>上:<input type='text' id='topHeight' value='"+this.topHeight+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>右:<input type='text' id='rightWidth' value='"+this.rightWidth+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td><td>下:<input type='text' id='bottomHeight' value='"+this.bottomHeight+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>百分比宽:</td><td><input type='text' id='percentWidth' value='"+this.percentWidth+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>百分比高:</td><td><input type='text' id='percentHeight' value='"+this.percentHeight+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="</table>",document.getElementById("elmProperty").innerHTML=a},this.changeElm=function(a){this.baseChangeElm(a),"percentWidth"==a.id&&(this[a.id]=parseInt(a.value),this[a.id]>100&&(this[a.id]=100),this[a.id]<0&&(this[a.id]=0),this.scaleX=1),"percentHeight"==a.id&&(this.scaleY=1,this[a.id]=parseInt(a.value),this[a.id]>100&&(this[a.id]=100),this[a.id]<0&&(this[a.id]=0)),"leftWidth"!==a.id&&"topHeight"!==a.id&&"rightWidth"!==a.id&&"bottomWidth"!==a.id||(this[a.id]=parseInt(a.value),this.content.parent.removeChild(this.content),this.content=new PIXI.mesh.NineSlicePlane(UIProject.getInstance().loaderRes[this.resName].texture,this.leftWidth,this.topHeight,this.rightWidth,this.bottomHeight),this.view.addChild(this.content),this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height),"resName"==a.id&&(this.resName=a.value,this.content.parent.removeChild(this.content),this.content=new PIXI.mesh.NineSlicePlane(UIProject.getInstance().loaderRes[this.resName].texture,this.leftWidth,this.topHeight,this.rightWidth,this.bottomHeight),this.view.addChild(this.content),this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height),Director.getInstance().postMsg("elementUpdate",this)},void(this.updateView=function(a){var b=null;b=UIProject.getInstance().loaderRes?UIProject.getInstance().loaderRes[this.resName].texture:UIManager.getInstance().loaderRes[this.resName].texture,this.content.parent&&this.content.parent.removeChild(this.content),this.content=new PIXI.mesh.NineSlicePlane(b,this.leftWidth,this.topHeight,this.rightWidth,this.bottomHeight),this.view.addChild(this.content),this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.content.width=this.width,this.content.height=this.height,UIProject.getInstance().currentUI?(this.percentWidth>0&&(this.content.width=UIProject.getInstance().currentUI.width*this.percentWidth/100),this.percentHeight>0&&(this.content.height=UIProject.getInstance().currentUI.height*this.percentHeight/100)):(this.percentWidth>0&&(this.content.width=UIManager.getInstance().currentFile.width*this.percentWidth/100),this.percentHeight>0&&(this.content.height=UIManager.getInstance().currentFile.height*this.percentHeight/100)),this.baseUpdateView(a)}))}function elmCreate(a){var b=null;switch(a.type){case"shape":b=new ShapeElement,b.setJson(a);break;case"ui":b=new UIElement,b.setJson(a);break;case"pic":b=new PicElement(a.resName),b.setJson(a);break;case"text":b=new TextElement,b.setJson(a);break;case"slice9":b=new Slice9Element(a.resName),b.setJson(a)}return b}function elmFactory(a){var b=elmCreate(a);return b.id=a.id,b}function BaseElement(){this.view=new PIXI.Container,this.content=null,this.errorNo=0,this.rootId=0,this.childrenNum=0,UIProject.getInstance().maxElmNum++,this.id=UIProject.getInstance().maxElmNum,this.width=0,this.height=0,this.posX=0,this.posY=0,this.PosTypeX=0,this.PosTypeY=0,this.scaleX=1,this.scaleY=1,this.instName="instName",this.rotation=0,this.anchorX=0,this.anchorY=0,this.order=0,this.alpha=1,this.visible=1,this.frameSetList={};var a=this;this.deleteFrameSet=function(a,b){for(var c in this.frameSetList[b])if(this.frameSetList[b][c].frame==a){this.frameSetList[b].splice(c,1);break}this.frameSetList[b].sort(function(a,b){return b.frame>a.frame?-1:1})},this.removeAction=function(a){this.frameSetList[a]=null,delete this.frameSetList[a]},this.addFrameSet=function(a,b){0==this.frameSetList.hasOwnProperty(b)&&(this.frameSetList[b]=[]),this.frameSetList[b].push(a),this.frameSetList[b].sort(function(a,b){return b.frame>a.frame?-1:1})},this.getFrameSet=function(a,b){if(0==this.frameSetList.hasOwnProperty(b))return null;var c=this.frameSetList[b];for(var d in c)if(c[d].frame==a)return c[d];return null},this.getPrevKeyFrame=function(a,b){if(0==this.frameSetList.hasOwnProperty(b))return null;var c=null,d=this.frameSetList[b];for(var e in d)if(c=d[e],c.frame>=a)return e>0?d[e-1]:null;return c},this.getNextKeyFrame=function(a,b){if(0==this.frameSetList.hasOwnProperty(b))return null;var c=this.frameSetList[b];for(var d in c)if(c[d].frame>=a)return c[d];return null},this.layerClick=function(){Director.getInstance().postMsg("layerClick",a)},this.layer=new Layer(a),this.updateLayer=function(){this.layer.updateView(this),0==this.view.visible?this.layer.hiddenButton.setTitle("显示"):this.layer.hiddenButton.setTitle("隐藏"),0==this.view.interactive?this.layer.lockButton.setTitle("解锁"):this.layer.lockButton.setTitle("上锁")},this.getCheckFrameObj=function(a,b){if(0==a)return null;var c=this.getFrameSet(a,b);if(null!==c)return c.getObject(this);var d={},e=this.getNextKeyFrame(a,b),f=this.getPrevKeyFrame(a,b);if(null==e||0==e.b_continue)return null==f?null:f.getObject(this);var g=e.getObject(this),h=null;if(null==f){if(h={},h.height=this.height,h.width=this.width,h.scaleX=this.scaleX,h.scaleY=this.scaleY,h.rotation=this.rotation,h.b_continue=this.b_continue,UIProject.getInstance().currentUI)var i=UIProject.getInstance().currentUI.getViewXValue(this.posX,this.PosTypeX),j=UIProject.getInstance().currentUI.getViewYValue(this.posY,this.PosTypeY);else var i=UIManager.getInstance().currentFile.getViewXValue(this.posX,this.PosTypeX),j=UIManager.getInstance().currentFile.getViewYValue(this.posY,this.PosTypeY);h.posX=i,h.posY=j,h.alpha=this.alpha,h.visible=this.visible,h.frame=0}else h=f.getObject(this);var k=g.frame-h.frame;return d.height=parseFloat((h.height+(a-h.frame)*(g.height-h.height)/k).toFixed(2)),d.width=parseFloat((h.width+(a-h.frame)*(g.width-h.width)/k).toFixed(2)),d.scaleX=parseFloat((h.scaleX+(a-h.frame)*(g.scaleX-h.scaleX)/k).toFixed(2)),d.scaleY=parseFloat((h.scaleY+(a-h.frame)*(g.scaleY-h.scaleY)/k).toFixed(2)),d.rotation=parseFloat((h.rotation+(a-h.frame)*(g.rotation-h.rotation)/k).toFixed(2)),d.posX=parseFloat((h.posX+(a-h.frame)*(g.posX-h.posX)/k).toFixed(2)),d.posY=parseFloat((h.posY+(a-h.frame)*(g.posY-h.posY)/k).toFixed(2)),d.alpha=parseFloat((h.alpha+(a-h.frame)*(g.alpha-h.alpha)/k).toFixed(2)),d.visible=h.visible,d.frame=-1,d},this.checkFrame=function(a,b){var c=this.getCheckFrameObj(a,b);this.updateView(c)},this.destroy=function(){this.removeFromParent()},this.removeFromParent=function(){this.view.parent&&this.view.parent.removeChild(this.view),this.layer.removeFromParent()};var a=(this.id,this);this.moveComplete=function(){Director.getInstance().postMsg("moveComplete",a)},this.updateMove=function(b){var c=this.getFrameSet(b,UIProject.getInstance().currentUI.actionIndex);if(null==c)this.posX=UIProject.getInstance().currentUI.getPosXValue(this.view.x,this.PosTypeX),this.posY=UIProject.getInstance().currentUI.getPosYValue(this.view.y,this.PosTypeY);else{var d=UIProject.getInstance().currentUI.getViewXValue(this.posX,this.PosTypeX),e=UIProject.getInstance().currentUI.getViewYValue(this.posY,this.PosTypeY);c.posX=this.view.x-d,c.posY=this.view.y-e}Director.getInstance().postMsg("elementUpdate",a)},DragManager.getInstance().addDragObj(this.view,this.moveComplete),this.textureJson=null,this.textureName=null,this.display=null,this.updatePosition=function(a){var b=0,c=0;null==a?(b=this.posX,c=this.posY,UIProject.getInstance().currentUI?(this.view.x=UIProject.getInstance().currentUI.getViewXValue(b,this.PosTypeX),this.view.y=UIProject.getInstance().currentUI.getViewYValue(c,this.PosTypeY)):(this.view.x=UIManager.getInstance().currentFile.getViewXValue(b,this.PosTypeX),this.view.y=UIManager.getInstance().currentFile.getViewYValue(c,this.PosTypeY))):(this.view.x=a.posX,this.view.y=a.posY)},this.baseUpdateView=function(a){null==a?(this.content.scale=new PIXI.Point(this.scaleX,this.scaleY),this.content.rotation=Math.PI*this.rotation/180,this.updatePosition(),this.content.alpha=this.alpha,this.content.visible=this.visible,this.content.rotation=this.rotation*Math.PI/180):(this.content.scale=new PIXI.Point(a.scaleX,a.scaleY),this.content.rotation=Math.PI*a.rotation/180,this.updatePosition(a),this.content.alpha=a.alpha,this.content.visible=a.visible)},this.baseChangeElm=function(a){if("visible"==a.id){var b=document.getElementById("visible").checked;this.visible=b}else{var c=this[a.id];switch(a.id){case"posX":case"posY":this[a.id]=a.value,this[a.id]=parseInt(this[a.id]);break;case"instName":this[a.id]=a.value;break;case"width":this[a.id]=a.value,this.content.width=this.width,this.scaleX=this.content.scale.x;break;case"height":this[a.id]=a.value,this.content.height=this.height,this.scaleY=this.content.scale.y;break;case"scaleX":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]),this.content.scale=new PIXI.Point(this.scaleX,this.scaleY),this.width=this.content.width;break;case"scaleY":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]),this.content.scale=new PIXI.Point(this.scaleX,this.scaleY),this.height=this.content.height;break;case"alpha":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]);break;case"anchorX":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY);break;case"anchorY":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]),
this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY);break;case"rotation":this[a.id]=a.value,this[a.id]=parseFloat(this[a.id]);break;case"PosTypeX":this[a.id]=a.value;var d=UIProject.getInstance().currentUI.getViewXValue(this.posX,c);this[a.id]=parseInt(this[a.id]),this.posX=UIProject.getInstance().currentUI.getPosXValue(d,this.PosTypeX);break;case"PosTypeY":this[a.id]=a.value;var e=UIProject.getInstance().currentUI.getViewYValue(this.posY,c);this[a.id]=parseInt(this[a.id]),this.posY=UIProject.getInstance().currentUI.getPosYValue(e,this.PosTypeY)}}this.updateLayer()},this.getBasePropertiesDiv=function(){var a="<table border='1'>";a+="<tr><td style='width:50%'>id:"+this.id+"</td><td><button onClick=UIProject.getInstance().currentEditor.delElm("+this.id+");>删除</button></td></tr>",a+="<tr><td colspan='2'>实例名:<input type='text' id='instName' value='"+this.instName+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>宽:<input type='text' id='width' value='"+this.width+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>",a+="<td>高:<input type='text' id='height' value='"+this.height+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+=1==this.visible?"<tr><td>显示:<input type='checkbox' id='visible'  checked onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>":"<tr><td>显示:<input type='checkbox' id='visible'  onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>",a+="<td>alpha:<input type='text' id='alpha' value='"+this.alpha+"' style='width:30px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>X:<input type='text' id='posX' value='"+this.posX+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>",a+="<td>Y:<input type='text' id='posY' value='"+this.posY+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>位置类型<select id='PosTypeX' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/>";for(var b in PosTypeXList)a+=b!=this.PosTypeX?"<option value="+b+">"+PosTypeXList[b]+"</option>":"<option value="+b+" selected>"+PosTypeXList[b]+"</option>";a+="</td>",a+="<td>位置类型<select id='PosTypeY' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/>";for(var b in PosTypeYList)a+=b!=this.PosTypeY?"<option value="+b+">"+PosTypeYList[b]+"</option>":"<option value="+b+" selected>"+PosTypeYList[b]+"</option>";return a+="</td></tr>",a+="<tr><td>scaleX:<input type='text' id='scaleX' value='"+this.scaleX+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>",a+="<td>scaleY:<input type='text' id='scaleY' value='"+this.scaleY+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td>anchorX:<input type='text' id='anchorX' value='"+this.anchorX+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td>",a+="<td>anchorY:<input type='text' id='anchorY' value='"+this.anchorY+"' style='width:50px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td colspan='2'>旋转:<input type='text' id='rotation' value='"+this.rotation+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="</table>"},this.getBaseJsonObj=function(){var a={};a.id=this.id,a.type=this.type,a.posX=this.posX,a.posY=this.posY,a.scaleX=this.scaleX,a.scaleY=this.scaleY,a.width=this.width,a.height=this.height,a.instName=this.instName,a.order=this.order,a.rootId=this.rootId,a.anchorX=this.anchorX,a.anchorY=this.anchorY,a.frameSetList=[],a.rotation=this.rotation;for(var b in this.frameSetList){a.frameSetList[b]=[];for(var c in this.frameSetList[b])a.frameSetList[b].push(this.frameSetList[b][c].getJson())}return a.PosTypeX=this.PosTypeX,a.PosTypeY=this.PosTypeY,a},this.setBaseJson=function(a){this.posX=parseInt(a.posX),this.posY=parseInt(a.posY),null!==a.scaleX&&(this.scaleX=parseFloat(a.scaleX)),null!==a.scaleY&&(this.scaleY=parseFloat(a.scaleY)),a.PosTypeX&&(this.PosTypeX=parseInt(a.PosTypeX)),a.PosTypeY&&(this.PosTypeY=parseInt(a.PosTypeY)),this.width=parseInt(a.width),this.height=parseInt(a.height),this.instName=a.instName,null!==a.order&&(this.order=parseInt(a.order)),null!==a.rootId&&(this.rootId=a.rootId),null!==a.anchorX&&(this.anchorX=parseFloat(a.anchorX)),null!==a.anchorY&&(this.anchorY=parseFloat(a.anchorY)),this.rotation=parseInt(a.rotation),this.frameSetList={};for(var b in a.frameSetList){this.frameSetList[b]=[];for(var c in a.frameSetList[b]){var d=JSON.parse(a.frameSetList[b][c]),e=new FrameSet(d.frame);e.setJson(d),this.frameSetList[b].push(e)}}this.updatePosition()},this.getPropertiesDiv=function(){alert("!!")},this.changeElm=function(){alert("!!")}}function PicElement(a){BaseElement.call(this),this.type="pic",this.instName=this.type,this.content=new PIXI.Sprite,void 0==a?this.resName=UIProject.getInstance().defaultResKey:this.resName=a;return null===this.resName?(alert("请先加载res资源"),void(this.errorNo=1)):(UIProject.getInstance().loaderRes?this.content.texture=UIProject.getInstance().loaderRes[this.resName].texture:this.content.texture=UIManager.getInstance().loaderRes[this.resName].texture,this.width=this.content.width,this.height=this.content.height,this.updateView=function(a){null==a?UIProject.getInstance().loaderRes?this.content.texture=UIProject.getInstance().loaderRes[this.resName].texture:this.content.texture=UIManager.getInstance().loaderRes[this.resName].texture:a.hasOwnProperty("resName")&&null!==a.resName?UIProject.getInstance().loaderRes?this.content.texture=UIProject.getInstance().loaderRes[a.resName].texture:this.content.texture=UIManager.getInstance().loaderRes[a.resName].texture:UIProject.getInstance().loaderRes?this.content.texture=UIProject.getInstance().loaderRes[this.resName].texture:this.content.texture=UIManager.getInstance().loaderRes[this.resName].texture,this.baseUpdateView(a)},this.view.addChild(this.content),this.getJson=function(){var a=this.getBaseJsonObj();return a.resName=this.resName,JSON.stringify(a)},this.setJson=function(a){this.setBaseJson(a),this.resName=a.resName,this.updateView(),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY)},this.getPropertiesHtml=function(){var a=this.getBasePropertiesDiv();a+="<table border='1'>",a+="<tr><td>图片:</td><td>",a+="<select id='resName' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'>";for(var b in UIProject.getInstance().resMap)a+=b==this.resName?"<option value='"+b+"' selected>"+b+"</option>":"<option value='"+b+"'>"+b+"</option>";a+="</select>",a+="</td></tr>",a+="</table>",document.getElementById("elmProperty").innerHTML=a},void(this.changeElm=function(a){this.baseChangeElm(a),"resName"==a.id&&(this.resName=a.value,this.content.texture=UIProject.getInstance().loaderRes[this.resName].texture,this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height),Director.getInstance().postMsg("elementUpdate",this)}))}function ShapeElement(){BaseElement.call(this),this.color="FF3300",this.type="shape",this.width=60,this.height=30,this.instName=this.type,this.content=new PIXI.Graphics,this.view.addChild(this.content),this.updateView=function(a){this.content.clear(),this.content.beginFill(parseInt("0x"+this.color)),this.content.drawRect(0,0,60,30),this.content.endFill(),this.baseUpdateView(a)},this.updateView(),this.getPropertiesHtml=function(){var a=this.getBasePropertiesDiv();a+="<table border='1'>",a+="<tr><td>颜色:</td><td><input id='color' type='text' value='"+this.color+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="</table>",document.getElementById("elmProperty").innerHTML=a;new jscolor(document.getElementById("color"),{onFineChange:'UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'})},this.changeElm=function(a){switch(a.id){case"color":this.color=a.value}this.baseChangeElm(a),this.updateView(),Director.getInstance().postMsg("elementUpdate",this)},this.getJson=function(){var a=this.getBaseJsonObj();return a.color=this.color,JSON.stringify(a)},this.setJson=function(a){this.setBaseJson(a),this.color=a.color,this.updateView(),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY)}}function TextElement(){BaseElement.call(this),this.text="新文本",this.type="text",this.size=24,this.color="ff0000",this.instName=this.type;var a=this,b={fontSize:a.size,fill:"#"+a.color};this.content=new PIXI.Text(this.text+"",b),this.width=this.content.width,this.height=this.content.height,this.updateView=function(a){this.content.text=this.text;var b=this.content.style;b.fontSize=this.size,b.fill="#"+this.color,this.content.style=b,this.baseUpdateView(a)},this.updateView(),this.view.addChild(this.content),this.getJson=function(){var a=this.getBaseJsonObj();return a.text=this.text,a.size=this.size,a.color=this.color,JSON.stringify(a)},this.setJson=function(a){this.setBaseJson(a),this.text=a.text,a.color&&(this.color=a.color),a.size&&(this.size=a.size),this.updateView(),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY)},this.getPropertiesHtml=function(){var a=this.getBasePropertiesDiv();a+="<table border='1'>",a+="<tr><td colspan='2'>文字:<input id='text' type='text' value='"+this.text+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td colspan='2'>大小:<input id='size' type='text' value='"+this.size+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="<tr><td colspan='2'>颜色:<input id='color' type='text' value='"+this.color+"' style='width:100px;' onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/></td></tr>",a+="</table>",document.getElementById("elmProperty").innerHTML=a;new jscolor(document.getElementById("color"),{onFineChange:'UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'})},this.changeElm=function(a){switch(this.baseChangeElm(a),a.id){case"size":this.size=parseInt(a.value);var b=this.content.style;b.fontSize=this.size,this.content.style=b,this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height;break;case"color":this.color=a.value;break;case"text":this.text=a.value,this.content.text=this.text,this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height}this.updateView(),Director.getInstance().postMsg("elementUpdate",this)}}function UIElement(){if(BaseElement.call(this),null!==UIProject.getInstance().fileMap)for(var a in UIProject.getInstance().fileMap)if(UIProject.getInstance().fileMap[a]!=UIProject.getInstance().currentUI){this.uiId=a;break}this.type="ui",this.instName=this.type,this.loader=new UILoader,this.updateUI=function(){null!==UIProject.getInstance().fileMap?this.loader.loadJson(UIProject.getInstance().fileMap[this.uiId]):this.loader.loadJson(UIManager.getInstance().uiKeyPool[this.uiId]),this.content&&this.content.parent&&this.content.parent.removeChild(this.content),this.content=this.loader.content,this.content.scale.x=this.scaleX,this.content.scale.y=this.scaleY,this.width=this.content.width,this.height=this.content.height,this.view.addChild(this.content)},this.updateView=function(a){this.updateUI(),this.baseUpdateView(a)},this.getPropertiesHtml=function(){var a=this.getBasePropertiesDiv();a+="<table border='1'>",a+="<tr><td colspan='2'>uiId:<select id='uiId'  onchange='UIProject.getInstance().currentEditor.changeElm(this,"+this.id+");'/>";for(var b in UIProject.getInstance().fileMap)UIProject.getInstance().fileMap[b]!=UIProject.getInstance().currentUI&&(a+=b==this.uiId?"<option value='"+b+"' selected>"+UIProject.getInstance().fileMap[b].fileName+"</option>":"<option value='"+b+"'>"+UIProject.getInstance().fileMap[b].fileName+"</option>");a+="</td></tr>",a+="</table>",document.getElementById("elmProperty").innerHTML=a},this.getJson=function(){var a=this.getBaseJsonObj();return a.uiId=this.uiId,JSON.stringify(a)},this.setJson=function(a){this.setBaseJson(a),this.uiId=a.uiId,this.updateView(),this.content.pivot=new PIXI.Point(this.anchorX*this.content.width/this.scaleX,this.anchorY*this.content.height/this.scaleY)},this.changeElm=function(a){this.baseChangeElm(a),"uiId"==a.id&&(this.uiId=a.value,this.updateUI()),Director.getInstance().postMsg("elementUpdate",this)}}function FrameSet(a){this.frame=a,this.width=0,this.height=0,this.scaleX=1,this.scaleY=1,this.rotation=0,this.b_continue=0,this.posX=0,this.posY=0,this.alpha=1,this.visible=1,this.resName=null,this.changeFrame=function(a,b){var c;switch(a.id){case"f_width":this.width=parseInt(document.getElementById("f_width").value),b.content.width=this.width,this.scaleX=b.content.scale.x;break;case"f_height":this.height=parseInt(document.getElementById("f_height").value),b.content.height=this.height,this.scaleY=b.content.scale.y;break;case"f_scaleX":this.scaleX=parseFloat(document.getElementById("f_scaleX").value),b.content.scale=new PIXI.Point(this.scaleX,this.scaleY),this.width=b.content.width;break;case"f_scaleY":this.scaleY=parseFloat(document.getElementById("f_scaleY").value),b.content.scale=new PIXI.Point(this.scaleX,this.scaleY),this.height=b.content.height;break;case"f_x":this.posX=parseInt(document.getElementById("f_x").value);break;case"f_y":this.posY=parseInt(document.getElementById("f_y").value);break;case"f_alpha":this.alpha=parseFloat(document.getElementById("f_alpha").value);break;case"f_continue":c=document.getElementById("f_continue").checked,c===!0?this.b_continue=1:this.b_continue=0;break;case"f_visible":c=document.getElementById("f_visible").checked,c===!0?this.visible=1:this.visible=0;break;case"f_rotation":this.rotation=parseInt(document.getElementById("f_rotation").value);break;case"f_resName":var d=document.getElementById("f_resName");d&&(this.resName=d.value)}},this.getJson=function(){var a=this.getObject();return JSON.stringify(a)},this.getObject=function(a){var b={};if(b.frame=this.frame,b.width=this.width,b.height=this.height,b.scaleX=this.scaleX,b.scaleY=this.scaleY,b.rotation=this.rotation,b.b_continue=this.b_continue,a){var c,d;UIProject.getInstance().currentUI?(c=UIProject.getInstance().currentUI.getViewXValue(a.posX,a.PosTypeX),d=UIProject.getInstance().currentUI.getViewYValue(a.posY,a.PosTypeY)):(c=UIManager.getInstance().currentFile.getViewXValue(a.posX,a.PosTypeX),d=UIManager.getInstance().currentFile.getViewYValue(a.posY,a.PosTypeY)),b.posX=c+this.posX,b.posY=d+this.posY}else b.posX=this.posX,b.posY=this.posY;return b.visible=this.visible,b.alpha=this.alpha,b.resName=this.resName,b},this.setJson=function(a){this.width=a.width,this.height=a.height,this.scaleX=a.scaleX,this.scaleY=a.scaleY,this.rotation=a.rotation,this.b_continue=a.b_continue,this.posX=a.posX,this.posY=a.posY,this.resName=a.resName,this.visible=a.visible,this.alpha=a.alpha}}function Layout(a,b){function c(a){var b=Math.round((a.x-5)/10);a.x=10*b+5,Director.getInstance().postMsg("selectFrame",b)}function d(a){var b=Math.round((a.x-5)/10);Director.getInstance().postMsg("selectFrame",b)}function e(a){f.cursor.x=10*a+5,Director.getInstance().postMsg("selectFrame",a)}PIXI.Graphics.call(this),this.beginFill(10066431,1),this.drawRect(0,0,a,b-500),this.endFill(),this.timeLine=new PIXI.Graphics,this.timeLine.beginFill(16777215,1),this.timeLine.drawRect(0,0,a-250,20),this.timeLine.endFill(),this.cursor=new Cursor(b-500),this.timeLine.addChild(this.cursor),this.content=new PIXI.Container;var f=this;this.timeLine.x=250,this.addChild(this.content),this.content.y=20,this.addChild(this.timeLine),ScrollDragManager.getInstance().addDragObj(this.content,a,b-500-50);var g;g=DragManager.getInstance().addDragObj(this.cursor,c,a-250,0),g.moveCallBack=d,this.scrollTop=function(){this.content.y=20},this.updateView=function(a){for(var b in a)a[b].layer.y=35*b,a[b].updateLayer()},Director.getInstance().addObserver(this,"frameClick",e)}function Cursor(a){PIXI.Container.call(this),this.block=new PIXI.Graphics,this.block.beginFill(0,1),this.block.drawRect(-5,0,10,20),this.block.endFill(),this.x=5,this.line=new PIXI.Graphics,this.block.beginFill(0,1),this.block.drawRect(-2,0,4,a),this.block.endFill(),this.addChild(this.block),this.addChild(this.line)}function Layer(a){PIXI.Graphics.call(this),this.beginFill(0,1),this.drawRect(0,0,850,35),this.endFill(),this.setSelect=function(a){this.clear(),a?this.beginFill(16711680,1):this.beginFill(0,1),this.drawRect(0,0,850,35),this.endFill()},this.layerClick=function(){Director.getInstance().postMsg("layerClick",a,1)},this.hiddenClick=function(){Director.getInstance().postMsg("layerClick",a,2)},this.lockClick=function(){Director.getInstance().postMsg("layerClick",a,3)},this.moveClick=function(){Director.getInstance().postMsg("layerClick",a,4)},this.enterClick=function(){Director.getInstance().postMsg("layerClick",a,5)},this.button=new SimpleButton("图层",this.layerClick),this.addChild(this.button),this.hiddenButton=new SimpleButton("隐藏",this.hiddenClick),this.addChild(this.hiddenButton),this.hiddenButton.x=100,this.lockButton=new SimpleButton("上锁",this.lockClick),this.addChild(this.lockButton),this.lockButton.x=150,this.moveButton=new SimpleButton("下移",this.moveClick),this.addChild(this.moveButton),this.moveButton.x=200,this.timeLine=new TimeLine,this.addChild(this.timeLine),this.timeLine.x=250,this.timeLine.y=2,this.setTitle=function(a){this.button.setTitle(a)},this.removeFromParent=function(){this.parent&&this.parent.removeChild(this)},this.updateView=function(a){this.button.setTitle(a.instName),this.timeLine.updateKeyPoint(a)}}function TimeLine(){PIXI.Container.call(this),this.list=[];for(var a=0;60>a;a++){var b=new FrameView(a);this.list.push(b),b.x=10*a,this.addChild(b),this.addChild(b.keyPoint)}this.updateKeyPoint=function(a){for(var b=1;60>b;b++)this.list[b].setKeyPoint(0),b>UIProject.getInstance().currentUI.getCurrentAction().actionTime?this.list[b].visible=!1:this.list[b].visible=!0;if(a.frameSetList.hasOwnProperty(UIProject.getInstance().currentUI.actionIndex)){var c=a.frameSetList[UIProject.getInstance().currentUI.actionIndex];for(var d in c)c[d].b_continue?this.list[c[d].frame].setKeyPoint(2):this.list[c[d].frame].setKeyPoint(1)}}}function FrameView(a){function b(b){var c=b.x;b.x=5+10*a,b.y=5,Director.getInstance().postMsg("keyPointDrag",a,c)}PIXI.Container.call(this);var c=new PIXI.Graphics;this.addChild(c),a%2===0?c.beginFill(10066329,1):c.beginFill(15658734,1),c.drawRect(0,0,10,30),c.endFill(),this.keyPoint=new PIXI.Graphics,this.keyPoint.beginFill(0,1),this.keyPoint.drawCircle(0,0,5),this.keyPoint.endFill(),this.addChild(this.keyPoint),this.keyPoint.x=5+10*a,this.keyPoint.y=5,this.setKeyPoint=function(a){return this.keyPoint.clear(),0===a?void DragManager.getInstance().removeDrag(this.keyPoint):(1==a?this.keyPoint.beginFill(0,1):2==a&&this.keyPoint.beginFill(16711680,1),this.keyPoint.drawCircle(0,0,5),this.keyPoint.endFill(),void DragManager.getInstance().addDragObj(this.keyPoint,b))},this.interactive=!0,this.on("mousedown",function(b){b.stopPropagation(),Director.getInstance().postMsg("frameClick",a)})}function UIProject(){EditController.getInstance(),this.currentEditor=new Editor,this.currentUI=null,this.fileMap=null,this.resMap={},this.loaderRes=null,this.defaultResKey=null,this.uiFileNum=0,this.maxElmNum=0;var a=this;this.loadRes=function(){var b=document.getElementById("fileRes").files[0],c=new FileReader;c.onload=function(b){function c(b,c){a.loaderRes=c,a.updateFileList()}var d=b.target.result,e=JSON.parse(d);a.resMap=e;var f=new PIXI.loaders.Loader;for(var g in a.resMap)null===a.defaultResKey&&(a.defaultResKey=g),f.add(g,a.resMap[g],{crossOrigin:!0});f.load(c)},c.readAsText(b)},this.initWithData=function(b){ajax({type:"GET",url:b,dataType:"text",data:{},beforeSend:function(){},success:function(b){a.doLoad(b)},error:function(){console.log("error")}})},this.doLoad=function(b){function c(b,c){a.loaderRes=c,a.updateFileList();for(var d in a.fileMap){a.doEnterUIFile(a.fileMap[d],!0);break}}var d=JSON.parse(b);a.resMap=d.resMap,a.fileMap={},d.maxElmNum&&(a.maxElmNum=parseInt(d.maxElmNum)),d.uiFileNum&&(a.uiFileNum=parseInt(d.uiFileNum));var e;for(e in d.fileMap)a.fileMap[e]=new UIFile,a.fileMap[e].loadJson(d.fileMap[e]);var f=new PIXI.loaders.Loader;for(e in a.resMap)null===a.defaultResKey&&(a.defaultResKey=e),f.add(e,a.resMap[e],{crossOrigin:!0});if(null!==a.defaultResKey)f.load(c);else{a.updateFileList();for(var e in a.fileMap){a.doEnterUIFile(a.fileMap[e],!0);break}}},this.load=function(){var b=document.getElementById("fileProject").files[0],c=new FileReader;c.onload=function(b){var c=b.target.result;a.doLoad(c)},c.readAsText(b)},this.save=function(){var a={};a.resMap=this.resMap,a.fileMap=this.fileMap,a.maxElmNum=this.maxElmNum,a.uiFileNum=this.uiFileNum;var b=JSON.stringify(a),c=new Blob([b],{type:"text/plain;charset=utf-8"});c=new Blob([String.fromCharCode(65279),c],{type:c.type});var d=document.createElement("a");d.target="_blank",d.href=URL.createObjectURL(c);var e=new MouseEvent("click");d.dispatchEvent(e),URL.revokeObjectURL(d.href)},this.initDiv=function(a){this.divObject=document.getElementById(a),this.updateFileList()},this.doNewFile=function(a){null===this.fileMap&&(this.fileMap={}),this.fileMap[a.id]=a,this.doEnterUIFile(a),this.updateFileList()},this.newFile=function(){var a=new UIFile;this.doNewFile(a),EditController.getInstance().addAction({action:"newFile",data:a})},this.doEnterUIFile=function(a,b){this.updateFileProperty(a),this.currentUI=a,this.currentEditor.setJsonMap(a,b),this.currentEditor.pixiLayout.scrollTop(),this.updateFileList()},this.enterUIFile=function(a){var b=this.fileMap[a];this.doEnterUIFile(b,!0)},this.doDelUIFile=function(a){a.destroy(),this.updateFileProperty(null),this.fileMap[a.id]=null,this.currentEditor.clear(),delete this.fileMap[a.id],this.currentUI=null,this.updateFileList()},this.delUIFile=function(a){var b=this.fileMap[a];this.doDelUIFile(b),EditController.getInstance().addAction({action:"delFile",data:b})},this.changeFile=function(a){var b=this.currentUI,c=JSON.stringify(b);b.getChange(a);var d=JSON.stringify(b);this.updateFileList(),this.updateFileProperty(b),EditController.getInstance().addAction({action:"changeFile",oldData:c,newData:d})},this.updateFileList=function(){var a="<div><button onclick='UIProject.getInstance().newFile();'>新增</button></div>";a+="<table>";for(var b in this.fileMap)a+="<tr>",a+="<td><a href='javascript:UIProject.getInstance().enterUIFile("+this.fileMap[b].id+");'>"+this.fileMap[b].fileName+"</a></td>",a+=this.currentUI==this.fileMap[b]?"<td><a href='javascript:UIProject.getInstance().delUIFile("+this.fileMap[b].id+");'>删除</a></td>":"<td></td>",a+="</tr>";a+="</table>",this.divObject.innerHTML=a},this.updateFileProperty=function(a){var b="";null!==a&&(b+=a.getHtml()),document.getElementById("elmProperty").innerHTML="",document.getElementById("frameProperty").innerHTML="",document.getElementById("fileProperty").innerHTML=b,document.getElementById("backcolor")&&new jscolor(document.getElementById("backcolor"))},this.addNewAction=function(){var a=document.getElementById("newAction").value,b=document.getElementById("newTime").value,c=new UIAction;c.actionName=a,c.actionTime=parseInt(b),this.currentUI.actionList.push(c),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm),EditController.getInstance().addAction({elmId:UIProject.getInstance().currentEditor.currentElm.id,action:"newAction",data:c,ui:this.currentUI.id})},this.deleteAction=function(a){EditController.getInstance().addAction({elmId:UIProject.getInstance().currentEditor.currentElm.id,actionIndex:a,action:"delAction",data:this.currentUI.actionList[a],ui:this.currentUI.id}),this.currentUI.actionList.splice(a,1),this.currentEditor.removeAction(a),this.currentUI.actionIndex=0,this.currentEditor.updateLayout(),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm)},this.changeAction=function(a){var b=document.getElementById("action"+a).value,c=document.getElementById("time"+a).value,d=document.getElementById("interval"+a).value,e=JSON.stringify(this.currentUI.actionList[a]);this.currentUI.actionList[a].actionName=b,this.currentUI.actionList[a].actionTime=c,this.currentUI.actionList[a].interval=d;var f=JSON.stringify(this.currentUI.actionList[a]);EditController.getInstance().addAction({actionIndex:this.currentUI.actionIndex,elmId:UIProject.getInstance().currentEditor.currentElm.id,action:"changeAction",oldData:e,newData:f,ui:this.currentUI.id}),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm),this.currentEditor.updateLayout()},this.selectAction=function(a){this.currentUI.actionIndex=a,this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm),this.currentEditor.updateLayout()},this.paste=function(a){if(null!==this.currentUI){var b=(a.clipboardData||window.clipboardData,a.clipboardData.getData("text/plain"));this.currentEditor.addPaste(b)}},this.copy=function(a){if(null!==this.currentUI&&null!==this.currentEditor.currentElm){var b=a.clipboardData||window.clipboardData;b.setData("text/plain",this.currentEditor.currentElm.getJson())}},this.cut=function(a){if(null!==this.currentUI&&null!==this.currentEditor.currentElm){var b=a.clipboardData||window.clipboardData;b.setData("text/plain",this.currentEditor.currentElm.getJson()),this.currentEditor.delElm(this.currentEditor.currentElm.id)}},this.undo=function(a){var b,c,d;switch(a.action){case"newFile":b=a.data,this.doDelUIFile(b);break;case"delFile":b=a.data,this.doNewFile(b);break;case"changeFile":c=JSON.parse(a.oldData),b=this.fileMap[c.id],null===UIProject.getInstance().currentUI||c.id!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollNext():b.loadJson(c),this.doEnterUIFile(b,!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d));break;case"newAction":null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollNext():(this.currentUI.actionList.pop(),this.currentUI.actionIndex=0,this.currentEditor.updateLayout()),this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm));break;case"delAction":null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollNext():this.currentUI.actionList.splice(a.actionIndex,0,a.data),this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm));break;case"changeAction":if(c=JSON.parse(a.oldData),null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id)EditController.getInstance().rollNext();else{var e=a.actionIndex;this.currentUI.actionList[e].actionName=c.actionName,this.currentUI.actionList[e].interval=c.interval,this.currentUI.actionList[e].actionTime=c.actionTime}this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm))}},this.redo=function(a){var b,c,d;switch(a.action){case"newFile":b=a.data,this.doNewFile(b);break;case"delFile":b=a.data,this.doDelUIFile(b);break;case"changeFile":c=JSON.parse(a.newData),b=this.fileMap[c.id],null===UIProject.getInstance().currentUI||c.id!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollBack():b.loadJson(c),this.doEnterUIFile(b,!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d));break;case"newAction":null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollBack():(UIProject.getInstance().currentUI.actionList.push(a.data),this.currentEditor.updateLayout()),this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm));break;case"delAction":null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id?EditController.getInstance().rollBack():(UIProject.getInstance().currentUI.actionList.splice(a.actionIndex,1),this.currentEditor.updateLayout()),this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm));break;case"changeAction":if(c=JSON.parse(a.newData),null===UIProject.getInstance().currentUI||a.ui!=UIProject.getInstance().currentUI.id)EditController.getInstance().rollBack();else{var e=a.actionIndex;this.currentUI.actionList[e].actionName=c.actionName,this.currentUI.actionList[e].interval=c.interval,this.currentUI.actionList[e].actionTime=c.actionTime}this.doEnterUIFile(this.fileMap[a.ui],!1),a.elmId&&(d=UIProject.getInstance().currentEditor.getElmById(a.elmId),UIProject.getInstance().currentEditor.doElementUpdate(d),this.currentEditor.updateFrameSetProperty(this.currentEditor.currentElm))}},Director.getInstance().addObserver(this,"fileSave",this.save),Director.getInstance().addObserver(this,"filePaste",this.paste),Director.getInstance().addObserver(this,"fileCopy",this.copy),Director.getInstance().addObserver(this,"fileCut",this.cut),Director.getInstance().addObserver(this,"fileUndo",this.undo),Director.getInstance().addObserver(this,"fileRedo",this.redo)}function UIData(){this.id=0,this.elmJsonMap={},this.actionList=[new UIAction],this.actionIndex=0,this.bindClassName="",this.autoResize=0,this.width=600,this.height=400,this.backcolor="FFFFFF",this.getViewXValue=function(a,b){var c=a;switch(b){case PosTypeX_Right:c=this.width-a;break;case PosType_Percentage:a>100&&(a=100),0>a&&(a=0),c=this.width*a/100}return c},this.getViewYValue=function(a,b){var c=a;switch(b){case PosTypeY_Bottom:c=this.height-a;break;case PosType_Percentage:a>100&&(a=100),0>a&&(a=0),c=this.height*a/100}return c},this.getPosXValue=function(a,b){var c=a;switch(b){case PosTypeX_Right:c=this.width-a;break;case PosType_Percentage:a>this.width&&(a=this.width),0>a&&(a=0),c=Math.round(100*a/this.width)}return c},this.getPosYValue=function(a,b){var c=a;switch(b){case PosTypeY_Bottom:c=this.height-a;break;case PosType_Percentage:a>this.height&&(a=this.height),0>a&&(a=0),c=Math.round(100*a/this.height)}return c},this.loadJson=function(a){this.id=a.id,this.elmJsonMap=a.elmJsonMap,this.actionList=a.actionList,this.actionIndex=a.actionIndex,this.bindClassName=a.bindClassName,this.fileName=a.fileName,(a.width||a.height||a.backcolor)&&(a.width&&(this.width=a.width),a.height&&(this.height=a.height),a.backcolor&&(this.backcolor=a.backcolor)),a.autoResize&&(this.autoResize=a.autoResize)}}function UIFile(){
UIData.call(this),UIProject.getInstance().uiFileNum++,this.id=UIProject.getInstance().uiFileNum,this.fileName="uiFile"+this.id,this.getCurrentAction=function(){return this.actionList[this.actionIndex]},this.getHtml=function(){var a="<table>";return a+="<tr><td>uiId:</td><td>"+this.id+"</td></tr>",a+="<tr><td>名称:</td><td><input type='text' id='fileName' value='"+this.fileName+"' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",a+="<tr><td>class:</td><td><input type='text' id='bindClassName' value='"+this.bindClassName+"' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",this.autoResize===!1?(a+="<tr><td>自适应:</td><td><input type='checkbox' id='autoResize' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",a+="<tr><td>宽:</td><td><input type='text' id='width' value='"+this.width+"' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",a+="<tr><td>高:</td><td><input type='text' id='height' value='"+this.height+"' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>"):a+="<tr><td>自适应:</td><td><input type='checkbox' id='autoResize' checked onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",a+="<tr><td>颜色:</td><td><input type='text' id='backcolor' value='"+this.backcolor+"' onchange='UIProject.getInstance().changeFile(this);'/></td></tr>",a+="</table>"},this.getChange=function(a){"autoResize"==a.id?this[a.id]=document.getElementById("autoResize").checked:(this[a.id]=a.value,"width"!=a.id&&"height"!=a.id&&"backcolor"!=a.id||Director.getInstance().postMsg("updateSceneSize"))},this.destroy=function(){UIProject.getInstance().currentEditor.removeAll()}}function UIAction(){this.actionName="default",this.actionTime=65,this.interval=1}function ScrollDragManager(){this.maxID=1,this.dragPool=[],this.enabled=!0,this.checkDragObj=function(a){for(var b in this.dragPool)if(this.dragPool[b].target==a)return this.dragPool[b];return null},this.addDragObj=function(a,b,c){var d=this.checkDragObj(a);null===d?(d=new DragObject,d.id=this.maxID,d.target=a,d.dragWidth=b,d.dragHeight=c,d.sourceX=a.x,d.sourceY=a.y,this.dragPool.push(d),this.maxID++,this.packageEvent(d)):(d.sourceX=a.x,d.sourceY=a.y),null===d.dragMask?(d.dragMask=new PIXI.Graphics,d.dragMask.beginFill(16711680,1),d.dragMask.drawRect(0,0,b,c),d.dragMask.endFill(),d.target.parent.addChild(d.dragMask),d.target.mask=d.dragMask):(d.dragMask.clear(),d.dragMask.drawRect(0,0,b,c),d.dragMask.endFill()),d.dragMask.x=a.x,d.dragMask.y=a.y},this.removeDrag=function(a){var b=null;for(var c in this.dragPool)if(this.dragPool[c].target==a){b=this.dragPool[c],b.dragMask&&b.dragMask.parent&&b.dragMask.parent.removeChild(b.dragMask),b.dragMask=null,this.dragPool.splice(c,1),this.removeEvent(b);break}},this.removeEvent=function(a){a.target.interactive=!1,a.target.buttonMode=!1,a.target.removeListener("mouseup"),a.target.removeListener("mousedown")};this.packageEvent=function(a){function b(b){b.stopPropagation();var c=b.data.getLocalPosition(this.parent);d.eventData&&(d.target.x=d.posX+c.x-d.mouseX,d.target.y=d.posY+c.y-d.mouseY,d.target.y<a.sourceY-d.maxHeight&&(d.target.y=a.sourceY-d.maxHeight),d.target.y>a.sourceY&&(d.target.y=a.sourceY),d.target.x<a.sourceX-d.maxWidth&&(d.target.x=a.sourceX-d.maxWidth),d.target.x>a.sourceX&&(d.target.x=a.sourceX))}function c(){d.target.y-=d.scrollSpdy,d.scrollSpdy>0?d.scrollSpdy-=.1:d.scrollSpdy+=.1,d.target.x-=d.scrollSpdx,d.scrollSpdx>0?d.scrollSpdx-=.1:d.scrollSpdx+=.1;var b=!1;d.target.y<a.sourceY-d.maxHeight&&(d.target.y=a.sourceY-d.maxHeight,b=!0),d.target.y>a.sourceY&&(d.target.y=a.sourceY,b=!0),d.target.x<a.sourceX-d.maxWidth&&(d.target.x=a.sourceX-d.maxWidth,b=!0),d.target.x>a.sourceX&&(d.target.x=a.sourceX,b=!0),Math.abs(d.scrollSpdx)+Math.abs(d.scrollSpdy)<1&&(b=!0),b===!1&&requestAnimationFrame(c)}var d=a;a.target.interactive=!0,a.target.buttonMode=!0,a.target.on("mousedown",function(a){if(a.stopPropagation(),d.enabled!==!1){var c=a.data.getLocalPosition(d.target.parent);d.posX=d.target.x,d.posY=d.target.y,d.eventData=a.data,d.mouseX=c.x,d.mouseY=c.y,d.scrollSpdx=0,d.scrollSpdy=0,d.downTime=(new Date).getTime(),d.maxWidth=d.target.width-d.dragWidth,d.maxHeight=d.target.height-d.dragHeight,d.target.on("mousemove",b)}}),a.target.on("mouseup",function(a){a.stopPropagation(),d.eventData=null,d.target.removeListener("mousemove",b);var e=a.data.getLocalPosition(this.parent),f=d.mouseX-e.x,g=d.mouseY-e.y,h=((new Date).getTime()-d.downTime)/20;100>h&&(d.scrollSpdx=f/h,d.scrollSpdy=g/h,c())}),a.target.on("mouseout",function(a){a.stopPropagation(),d.target.alpha=1,d.eventData=null,d.target.removeListener("mousemove",b)})}}function SelectDragManager(){this.maxID=1,this.enabled=!0,this.addDragObj=function(a,b,c){var d=new DragObject;d.id=this.maxID,d.target=b,d.callBack=c,this.maxID++,this.packageEvent(d,a)},this.removeEvent=function(a){a.target.interactive=!1,a.target.buttonMode=!1,a.target.removeListener("mouseup")},this.packageEvent=function(a,b){function c(a){var b=a.data.getLocalPosition(this.parent);d.eventData&&(d.target.x=d.posX+b.x-d.mouseX,d.target.y=d.posY+b.y-d.mouseY)}var d=a;a.target.interactive=!0,a.target.buttonMode=!0,a.target.alpha=.8,a.posX=a.target.x,a.posY=a.target.y,a.eventData=b.data;var e=b.data.getLocalPosition(d.target.parent);a.mouseX=e.x,a.mouseY=e.y,a.target.on("mousemove",c),a.target.on("mouseup",function(b){d.target.alpha=1,d.eventData=null,d.target.removeListener("mousemove",c),SelectDragManager.getInstance().removeEvent(d),d.dragComplete(),a=null})}}function SimpleButton(a,b){PIXI.Graphics.call(this);var c={font:"bold 12pt Arial",fill:"#fff",align:"center"};this.txtTitle=new PIXI.Text(a,c),this.txtTitle.x=10,this.txtTitle.y=10,this.addChild(this.txtTitle),this.setTitle=function(a){this.txtTitle.text=a,this.updateView()},this.updateView=function(){},this.updateView(),b&&(this.interactive=!0,this.buttonMode=!0,this.on("click",b))}function UILoader(){this.elmObj={},this.elmPool={},this.clsPool={},this.content=new PIXI.Container,this.animate={},this.uiFile=null;var self=this;this.loadJson=function(uiFile){for(;self.content.children.length>0;)self.content.removeChildAt(0);this.uiFile=uiFile;var jsonObj=uiFile.elmJsonMap,waitPool={},arr=[],key;for(key in jsonObj)arr.push(JSON.parse(jsonObj[key]));arr.sort(function(a,b){return a.order-b.order});var len=arr.length,hasAnimateObject={};for(key in uiFile.actionList)hasAnimateObject[key]=!1;for(var i=0;len>i;i++){var elm=elmFactory(arr[i]);if(self.elmObj[elm.instName]=elm,self.elmPool[elm.id]=elm,"ui"==elm.type){""!==UIManager.getInstance().uiKeyPool[elm.uiId].bindClassName&&(self.clsPool[elm.instName]=eval("new "+UIManager.getInstance().uiKeyPool[elm.uiId].bindClassName+"(elm.loader)"));var uiAnimate=elm.loader.getAnimate("default");null!==uiAnimate&&uiAnimate.play(-1),uiAnimate=elm.loader.getAnimate("default_once"),null!==uiAnimate&&uiAnimate.play(1)}elm.content.x=elm.view.x,elm.content.y=elm.view.y;for(key in uiFile.actionList)elm.frameSetList.hasOwnProperty(key)&&elm.frameSetList[key].length>0&&hasAnimateObject[key]===!1&&(hasAnimateObject[key]=!0);if(0===elm.rootId?self.content.addChild(elm.content):null==self.elmPool[elm.rootId]?(null==waitPool[elm.rootId]&&(waitPool[elm.rootId]=[]),waitPool[elm.rootId].push(elm)):self.elmPool[elm.rootId].content.addChild(elm.content),waitPool[elm.id])for(var len1=waitPool[elm.id].length,j=0;len1>j;j++)self.elmPool[elm.id].content.addChild(waitPool[elm.id][j].content)}for(key in hasAnimateObject)if(hasAnimateObject[key]===!0){var uiAnimate1=new UIAnimate(uiFile,key,self.content);this.animate[uiFile.actionList[key].actionName]=uiAnimate1;for(var key1 in self.elmObj)for(var obj=uiAnimate1.addElmObj(self.elmObj[key1]),ii=0;ii<uiAnimate1.maxFrame;ii++){var animateObj=self.elmObj[key1].getCheckFrameObj(ii,key);obj.frameList.push(animateObj)}}return self.content},this.getAnimate=function(a){return this.animate.hasOwnProperty(a)?this.animate[a]:null},this.getElmByName=function(a){var b=null;if("ui"==this.elmObj[a].type){if(this.clsPool.hasOwnProperty(a))return this.clsPool[a];b=this.elmObj[a].content}else b=this.elmObj[a].content;return b},this.getBtnByName=function(a){var b=this.elmObj[a].content;return b.interactive=!0,b.buttonMode=!0,b}}function UIAnimate(a,b,c){this.state=UIAnimate_State_Stop;var d=this,e=0;this.intervalFrame=0,this.maxFrame=a.actionList[b].actionTime,this.completeFun=null,this.userData=null,this.autoRemove=!1,this.elmList=[],this.defaultInterval=parseInt(a.actionList[b].interval),this.interval=0,this.loopNum=0,this.maxLoopNum=0,this.addElmObj=function(a){var b={};return b.elm=a,b.frameList=[],this.elmList.push(b),b},this.setFrameSet=function(a){this.state=UIAnimate_State_Stop;for(var b in d.elmList){var c=d.elmList[b].frameList[a];null!==c&&(d.elmList[b].elm.updateView(c),d.elmList[b].elm.content.x=d.elmList[b].elm.view.x,d.elmList[b].elm.content.y=d.elmList[b].elm.view.y)}},this.stop=function(){this.setFrameSet(0)},this.play=function(a,b){this.state!=UIAnimate_State_Runing&&(this.state=UIAnimate_State_Runing,this.maxLoopNum=a,this.loopNum=1,e=0,void 0===b||0===b?this.interval=this.defaultInterval:this.interval=b,d.intervalFrame=0,d.doRun(),this.run())},this.doRun=function(){if(d.state!=UIAnimate_State_Stop)if(e<d.maxFrame){requestAnimationFrame(d.run);for(var a in d.elmList){var b=d.elmList[a].frameList[e];null!==b&&(d.elmList[a].elm.updateView(b),d.elmList[a].elm.content.x=d.elmList[a].elm.view.x,d.elmList[a].elm.content.y=d.elmList[a].elm.view.y)}e++,e==d.maxFrame&&(-1==d.maxLoopNum?e=0:d.loopNum<d.maxLoopNum&&(e=0,d.loopNum++))}else d.state=UIAnimate_State_Stop,null!==d.completeFun&&d.completeFun(d.userData),d.autoRemove===!0&&c.parent&&c.parent.removeChild(c)},this.run=function(){return d.intervalFrame<d.interval?(d.intervalFrame++,void requestAnimationFrame(d.run)):(d.intervalFrame=0,void d.doRun())}}function UIManager(){this.uiPool={},this.uiKeyPool={},this.loaderRes=null,this.currentFile=null,this.filePool={};var self=this;this.loadURL=function(url,func,app){function getData(obj){function onAssetsLoaded(loader,res){self.loaderRes=res;var key;for(key in obj.fileMap)self.uiKeyPool[obj.fileMap[key].id]=obj.fileMap[key],self.uiKeyPool[obj.fileMap[key].fileName]=obj.fileMap[key];for(key in obj.fileMap){var ui=new UILoader;UIManager.getInstance().currentFile=new UIData,UIManager.getInstance().currentFile.loadJson(obj.fileMap[key]),UIManager.getInstance().filePool[UIManager.getInstance().currentFile.fileName]=UIManager.getInstance().currentFile,null!==app&&UIManager.getInstance().currentFile.autoResize&&(UIManager.getInstance().currentFile.width=app.renderer.width/PIXI.settings.RENDER_OPTIONS.resolution,UIManager.getInstance().currentFile.height=app.renderer.height/PIXI.settings.RENDER_OPTIONS.resolution),ui.loadJson(obj.fileMap[key]);var uiAnimate=ui.getAnimate("default");null!==uiAnimate&&uiAnimate.play(-1),uiAnimate=ui.getAnimate("default_once"),null!==uiAnimate&&uiAnimate.play(1),""!==obj.fileMap[key].bindClassName?self.uiPool[obj.fileMap[key].fileName]=eval("new "+obj.fileMap[key].bindClassName+"(ui)"):self.uiPool[obj.fileMap[key].fileName]=ui}func(self.uiPool)}var loader=new PIXI.loaders.Loader,options={crossOrigin:!0};for(var key in obj.resMap)loader.add(key,obj.resMap[key],options);loader.load(onAssetsLoaded)}ajax({type:"GET",url:url,dataType:"json",data:{},beforeSend:function(){},success:function(a){getData(a)},error:function(){console.log("error")}})},this.createUIByName=function(name){var ui=new UILoader;ui.loadJson(self.uiKeyPool[name]);var uiAnimate=ui.getAnimate("default");null!==uiAnimate&&uiAnimate.play(-1),uiAnimate=ui.getAnimate("default_once"),null!==uiAnimate&&uiAnimate.play(1);var res=null;return res=""!==self.uiKeyPool[name].bindClassName?eval("new "+self.uiKeyPool[name].bindClassName+"(ui);"):ui}}function UIBase(a){this.content=a.content,this.uiFile=a,this.onEnter=function(){}}function getRandomNum(a,b){var c=b-a,d=Math.random();return a+Math.round(d*c)}function alertLog(){var a=Array.prototype.slice.call(arguments);alert(a.join(","))}function ajax(){var a={type:arguments[0].type||"GET",url:arguments[0].url||"",async:arguments[0].async||"true",data:arguments[0].data||null,dataType:arguments[0].dataType||"text",contentType:arguments[0].contentType||"application/x-www-form-urlencoded",beforeSend:arguments[0].beforeSend||function(){},success:arguments[0].success||function(){},error:arguments[0].error||function(){}};a.beforeSend();var b=createxmlHttpRequest();b.responseType=a.dataType,b.open(a.type,a.url,a.async),b.setRequestHeader("Content-Type",a.contentType),b.send(convertData(a.data)),b.onreadystatechange=function(){4==b.readyState&&(200==b.status?a.success(b.response):a.error())}}function createxmlHttpRequest(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:void 0}function convertData(a){if("object"==typeof a){var b="";for(var c in a)b+=c+"="+a[c]+"&";return b=b.substring(0,b.length-1)}return a}Director.instance=null,Director.getInstance=function(){return null===Director.instance&&(Director.instance=new Director),Director.instance},DragManager.instance=null,DragManager.getInstance=function(){return null==DragManager.instance&&(DragManager.instance=new DragManager),DragManager.instance},EditController.instance=null,EditController.getInstance=function(){return null===EditController.instance&&(EditController.instance=new EditController),EditController.instance},PIXI.settings.RENDER_OPTIONS.resolution=window.devicePixelRatio,PIXI.settings.RENDER_OPTIONS.autoResize=!0;var PosTypeX_Left=0,PosTypeX_Right=1,PosTypeY_Up=0,PosTypeY_Bottom=1,PosType_Percentage=2,PosTypeXList=["左","右","百分比"],PosTypeYList=["上","下","百分比"];Layout.prototype=Object.create(PIXI.Graphics.prototype),Cursor.prototype=Object.create(PIXI.Container.prototype),Layer.prototype=Object.create(PIXI.Graphics.prototype),TimeLine.prototype=Object.create(PIXI.Container.prototype),FrameView.prototype=Object.create(PIXI.Container.prototype),UIProject.instance=null,UIProject.getInstance=function(){return null===UIProject.instance&&(UIProject.instance=new UIProject),UIProject.instance},ScrollDragManager.instance=null,ScrollDragManager.getInstance=function(){return null===ScrollDragManager.instance&&(ScrollDragManager.instance=new ScrollDragManager),ScrollDragManager.instance},SelectDragManager.instance=null,SelectDragManager.getInstance=function(){return null===SelectDragManager.instance&&(SelectDragManager.instance=new SelectDragManager),SelectDragManager.instance},SimpleButton.prototype=Object.create(PIXI.Graphics.prototype);var UIAnimate_State_Stop=0,UIAnimate_State_Runing=1;PIXI.settings.RENDER_OPTIONS.resolution=window.devicePixelRatio,PIXI.settings.RENDER_OPTIONS.autoResize=!0,UIManager.instance=null,UIManager.getInstance=function(){return null===UIManager.instance&&(UIManager.instance=new UIManager),UIManager.instance};
//# sourceMappingURL=UIEditor.min.js.map